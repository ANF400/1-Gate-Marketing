<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEVAL Reporting System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --meval-orange: #FF7F00;
            --meval-yellow: #FFD700;
        }

        body { 
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            position: relative;
            background: linear-gradient(135deg, var(--meval-orange) 0%, var(--meval-yellow) 100%);
            overflow-x: hidden;
        }

        /* Efek Watermark MEVAL Tekstur */
        body::before {
            content: "MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL MEVAL";
            position: fixed;
            top: 0;
            left: 0;
            width: 150%;
            height: 150%;
            z-index: 0;
            font-size: 2.5rem;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.12);
            transform: rotate(-20deg);
            pointer-events: none;
            overflow: hidden;
            word-wrap: break-word;
            line-height: 1.8;
            text-align: justify;
        }

        .glass-card { 
            background: rgba(255, 255, 255, 0.96); 
            border-radius: 25px; 
            padding: 30px; 
            width: 100%; 
            max-width: 450px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255,255,255,0.6);
        }

        .logo-img { max-width: 150px; display: block; margin: 0 auto 20px; }
        
        .btn-meval { 
            background: #FF4500; 
            color: white; 
            font-weight: bold; 
            border-radius: 12px; 
            border: none; 
            padding: 14px; 
            width: 100%; 
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-meval:hover:not(:disabled) { background: #E63E00; transform: translateY(-2px); }
        .btn-meval:disabled { background: #999; cursor: not-allowed; }

        .btn-google { 
            background: white; 
            color: #444; 
            border: 1px solid #ddd; 
            padding: 12px; 
            border-radius: 12px; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            width: 100%; 
        }

        .user-info { background: #FFF9F0; padding: 12px; border-radius: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; border: 1px solid #FFE0B2; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--meval-orange); }

        .gps-status { font-size: 0.75rem; padding: 10px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .gps-on { background: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .gps-off { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }

        .d-none { display: none !important; }
        label { font-size: 0.8rem; font-weight: 700; margin-bottom: 4px; color: #333; }
        .form-control, .form-select { border-radius: 10px; border: 1px solid #ccc; padding: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="glass-card">
    <img src="logo-web-300x92-1.jpg" alt="MEVAL Logo" class="logo-img">
    
    <div id="loginSection" class="text-center">
        <h5 class="fw-bold mb-3">REPORTING SYSTEM</h5>
        <p class="small text-muted mb-4">Harap aktifkan GPS & masuk dengan akun Google.</p>
        <button id="loginBtn" class="btn-google">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google">
            Sign in with Google
        </button>
    </div>

    <div id="formSection" class="d-none">
        <div class="user-info">
            <img id="userImg" src="">
            <div id="userDetails" style="font-size: 0.8rem; line-height: 1.2;"></div>
        </div>

        <div id="gpsAlert" class="gps-status gps-off">MENCARI LOKASI GPS...</div>

        <form id="reportForm">
            <div class="mb-3">
                <label>DIVISI / POSISI</label>
                <select id="posisi" class="form-select" required>
                    <option value="" disabled selected>Pilih Divisi...</option>
                    <option value="Admin_Ecommerce">Admin E-commerce</option>
                    <option value="Branding_Promotion">Branding & Promotion</option>
                    <option value="CS_Social_Media">CS Social Media</option>
                    <option value="Content_Creator">Content Creator</option>
                    <option value="Design_Graphic">Design Graphic</option>
                    <option value="Ecommerce_Specialist">E-commerce Specialist</option>
                    <option value="KOL_Affiliate">KOL & Affiliate</option>
                    <option value="Merchandiser_Display">Merchandiser Display</option>
                    <option value="TL_Event">TL Event</option>
                    <option value="Trade_Marketing_Specialist">Trade Marketing Specialist</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label>NAMA STAFF</label>
                <input type="text" id="staffNameInput" class="form-control" required>
            </div>

            <div class="mb-3">
                <label>DETAIL AKTIVITAS</label>
                <textarea id="aktivitas" class="form-control" rows="3" placeholder="Apa yang Anda kerjakan hari ini?" required></textarea>
            </div>

            <div class="mb-3">
                <label>FOTO KEGIATAN (WAJIB)</label>
                <input type="file" id="fotoFile" class="form-control" accept="image/*" required>
            </div>

            <div class="mb-4">
                <label>FILE LAPORAN (OPSIONAL)</label>
                <input type="file" id="dokumenFile" class="form-control" accept=".pdf,.xlsx,.xls,.doc,.docx">
            </div>

            <button type="submit" id="submitBtn" class="btn-meval" disabled>MENUNGGU GPS...</button>
            <button type="button" id="logoutBtn" class="btn btn-link btn-sm w-100 text-muted mt-3 text-decoration-none small">Logout</button>
        </form>
        <div id="status" class="mt-3 text-center small d-none"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyF9tXkVZ_A9TnF2yDwN_4WJQDOL1unch50-SaLMDkB411dM3IUv8HdJzNrOwtpueSFog/exec';

    firebase.initializeApp({
        apiKey: "AIzaSyDBvhpl4FtPcQf54t5h_o9sFQWAEApTom0",
        authDomain: "gate-marketing.firebaseapp.com",
        projectId: "gate-marketing"
    });

    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    let currentGps = null;

    function checkGPS() {
        const gpsAlert = document.getElementById('gpsAlert');
        const submitBtn = document.getElementById('submitBtn');

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    currentGps = "https://www.google.com/maps?q=" + lat + "," + lon;
                    
                    gpsAlert.innerText = "LOKASI TERKUNCI";
                    gpsAlert.className = "gps-status gps-on";
                    submitBtn.disabled = false;
                    submitBtn.innerText = "KIRIM LAPORAN SEKARANG";
                },
                err => {
                    currentGps = null;
                    let msg = "GPS BELUM AKTIF";
                    if(err.code == 1) msg = "IZIN GPS DITOLAK!";
                    if(err.code == 2) msg = "SINYAL GPS LEMAH!";
                    
                    gpsAlert.innerText = msg + " HARAP AKTIFKAN LOKASI.";
                    gpsAlert.className = "gps-status gps-off";
                    submitBtn.disabled = true;
                    submitBtn.innerText = "GAGAL MENGUNCI LOKASI";
                },
                { 
                    enableHighAccuracy: true, 
                    maximumAge: 0 
                    // Timeout dihapus agar terus mencari
                }
            );
        }
    }

    // Interval dipercepat menjadi 4 detik untuk responsivitas
    setInterval(checkGPS, 4000); 

    document.getElementById('loginBtn').onclick = () => {
        auth.signInWithPopup(provider).then(() => checkGPS());
    };
    document.getElementById('logoutBtn').onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginSection').classList.add('d-none');
            document.getElementById('formSection').classList.remove('d-none');
            document.getElementById('userImg').src = user.photoURL;
            document.getElementById('userDetails').innerHTML = `<b>${user.displayName}</b><br>${user.email}`;
            document.getElementById('staffNameInput').value = user.displayName;
            checkGPS();
        } else {
            document.getElementById('loginSection').classList.remove('d-none');
            document.getElementById('formSection').classList.add('d-none');
        }
    });

    const fileToBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    document.getElementById('reportForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        btn.disabled = true; btn.innerText = "MENGIRIM...";
        
        try {
            const foto = document.getElementById('fotoFile').files[0];
            const dok = document.getElementById('dokumenFile').files[0];

            const payload = {
                nama: document.getElementById('staffNameInput').value,
                email: auth.currentUser.email,
                posisi: document.getElementById('posisi').value,
                aktivitas: document.getElementById('aktivitas').value,
                lokasi: currentGps,
                fotoData: await fileToBase64(foto),
                fotoName: foto.name,
                dokData: dok ? await fileToBase64(dok) : null,
                dokName: dok ? dok.name : null
            };

            const res = await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });
            const data = await res.json();
            if(data.result === 'success') {
                status.className = "alert alert-success mt-3";
                status.innerText = "LAPORAN BERHASIL TERKIRIM!";
                document.getElementById('reportForm').reset();
                checkGPS();
            }
        } catch (err) {
            status.className = "alert alert-danger mt-3";
            status.innerText = "Gagal Mengirim. Cek File/Koneksi.";
        } finally {
            btn.disabled = false;
            btn.innerText = "KIRIM LAPORAN SEKARANG";
            status.classList.remove('d-none');
        }
    };
</script>
</body>
</html>
